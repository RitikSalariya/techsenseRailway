{% extends "base.html" %}
{% load static %}

{% block content %}
<section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
  <div class="max-w-md mx-auto">

    <div class="text-center mb-8">
      <h1 class="text-2xl font-semibold text-[#0F172A] mb-2">Forgot password</h1>
      <p class="text-sm text-[#0F172A]/60">
        Enter your registered phone number and weâ€™ll send you an OTP to reset your password.
      </p>
    </div>

    {% if messages %}
      <div class="mb-4 space-y-2">
        {% for message in messages %}
          <div class="text-sm px-4 py-3 rounded-xl
                      {% if message.tags == 'success' %}
                        bg-emerald-50 text-emerald-700 border border-emerald-100
                      {% elif message.tags == 'error' %}
                        bg-red-50 text-red-700 border border-red-100
                      {% else %}
                        bg-slate-50 text-slate-700 border border-slate-100
                      {% endif %}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <div class="bg-white rounded-3xl shadow-xl border border-slate-100 p-8 space-y-5">
      <div class="space-y-1">
        <label class="text-sm font-medium text-[#0F172A]" for="phone">
          Phone number
        </label>
        <input id="phone" type="text"
               class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm
                      focus:outline-none focus:ring-2 focus:ring-[#4F46E5]/40 focus:border-[#4F46E5]
                      placeholder:text-slate-400"
               placeholder="Enter your registered phone">
      </div>

      <button id="sendOtpBtn"
              class="w-full inline-flex items-center justify-center px-4 py-2.5 rounded-xl
                     bg-[#4F46E5] text-white text-sm font-semibold shadow-md
                     hover:bg-[#4338CA] transition">
        Send OTP
      </button>

      <div id="otpSection" class="space-y-4 hidden pt-4 border-t border-slate-100 mt-4">
        <div class="space-y-1">
          <label class="text-sm font-medium text-[#0F172A]" for="otp">
            OTP
          </label>
          <input id="otp" type="text"
                 class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm
                        focus:outline-none focus:ring-2 focus:ring-[#4F46E5]/40 focus:border-[#4F46E5]
                        placeholder:text-slate-400"
                 placeholder="Enter the OTP you received">
        </div>

        <button id="verifyOtpBtn"
                class="w-full inline-flex items-center justify-center px-4 py-2.5 rounded-xl
                       bg-emerald-500 text-white text-sm font-semibold shadow-md
                       hover:bg-emerald-600 transition">
          Verify OTP & Continue
        </button>
      </div>

      <p id="statusMsg" class="text-xs text-center text-slate-500"></p>
    </div>
  </div>
</section>

<script>
  // get CSRF token from cookie
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  const sendBtn = document.getElementById('sendOtpBtn');
  const verifyBtn = document.getElementById('verifyOtpBtn');
  const otpSection = document.getElementById('otpSection');
  const statusMsg = document.getElementById('statusMsg');

  if (sendBtn) {
    sendBtn.addEventListener('click', async () => {
      const phone = document.getElementById('phone').value.trim();
      statusMsg.textContent = '';

      if (!phone) {
        statusMsg.textContent = 'Please enter your phone number.';
        return;
      }

      try {
        const res = await fetch("{% url 'store:send_otp' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": csrftoken,
          },
          body: new URLSearchParams({ phone })
        });

        const data = await res.json();
        if (data.status === "sent") {
          statusMsg.textContent = 'OTP sent. Please check your phone.';
          otpSection.classList.remove('hidden');
        } else {
          statusMsg.textContent = 'Could not send OTP. Please try again.';
        }
      } catch (err) {
        console.error(err);
        statusMsg.textContent = 'Network error. Please try again.';
      }
    });
  }

  if (verifyBtn) {
    verifyBtn.addEventListener('click', async () => {
      const phone = document.getElementById('phone').value.trim();
      const otp = document.getElementById('otp').value.trim();
      statusMsg.textContent = '';

      if (!otp) {
        statusMsg.textContent = 'Please enter the OTP.';
        return;
      }

      try {
        const res = await fetch("{% url 'store:verify_otp' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": csrftoken,
          },
          body: new URLSearchParams({ phone, otp })
        });

        const data = await res.json();
        if (data.status === "verified") {
          statusMsg.textContent = 'OTP verified. Redirecting...';
          window.location.href = "{% url 'store:reset_password' %}";
        } else {
          statusMsg.textContent = 'Invalid OTP. Please try again.';
        }
      } catch (err) {
        console.error(err);
        statusMsg.textContent = 'Network error. Please try again.';
      }
    });
  }
</script>
{% endblock %}
